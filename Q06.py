import streamlit as st
import pandas as pd
import json
import utility as ut
import database as db
from datetime import datetime


# Page configuration
st.set_page_config(page_title="‡∏£‡∏∞‡∏ö‡∏ö‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏£‡πâ‡∏≤‡∏ô‡∏≠‡∏≤‡∏´‡∏≤‡∏£", page_icon="üçú", layout="wide")
st.markdown('<style>div.block-container{padding-top:1.85rem;}</style>', unsafe_allow_html=True)

from streamlit_extras.image_in_tables import table_with_images

# Initialize session state
if 'client' not in st.session_state:
    st.session_state.client = db.init_google_sheets()

if 'current_page' not in st.session_state:
    st.session_state.current_page = 'orders'


# Dialog to add product
@st.dialog("‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤")
def show_dialogAddProd():
    cols = st.columns([1, 3, 2], vertical_alignment="top")
    id = cols[0].text_input("‡∏£‡∏´‡∏±‡∏™‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤")
    name = cols[1].text_input("‡∏ä‡∏∑‡πà‡∏≠‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤")
    price = cols[2].number_input("‡∏£‡∏≤‡∏Ñ‡∏≤", min_value=0.0, step=0.5)

    category = st.selectbox("‡∏´‡∏°‡∏ß‡∏î‡∏´‡∏°‡∏π‡πà", ["‡∏≠‡∏≤‡∏´‡∏≤‡∏£‡∏à‡∏≤‡∏ô‡∏´‡∏•‡∏±‡∏Å", "‡∏Ç‡∏≠‡∏á‡∏ó‡∏≤‡∏ô‡πÄ‡∏•‡πà‡∏ô", "‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏î‡∏∑‡πà‡∏°", "‡∏Ç‡∏≠‡∏á‡∏´‡∏ß‡∏≤‡∏ô","‡πÑ‡∏°‡πâ‡∏°‡∏á‡∏Ñ‡∏•"])
    
    # ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏ä‡πà‡∏≠‡∏á‡∏Å‡∏£‡∏≠‡∏Å‡πÅ‡∏ö‡∏£‡∏ô‡∏î‡πå
    brand = cols[1].text_input("‡πÅ‡∏ö‡∏£‡∏ô‡∏î‡πå")

    # Image upload
    uploaded_file = st.file_uploader("‡∏≠‡∏±‡∏õ‡πÇ‡∏´‡∏•‡∏î‡∏£‡∏π‡∏õ‡∏†‡∏≤‡∏û‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤", type=['png', 'jpg', 'jpeg'])
    image_url = None

    if uploaded_file:
        image_url = ut.upload_image_to_cloudinary(uploaded_file)
        if image_url:
            st.image(uploaded_file, caption="‡∏£‡∏π‡∏õ‡∏†‡∏≤‡∏û‡∏ó‡∏µ‡πà‡∏≠‡∏±‡∏õ‡πÇ‡∏´‡∏•‡∏î", width=200)

    if st.button("‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤", type="primary", key="add_product"):
        if name and price > 0 and image_url and brand:  # ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡πÅ‡∏ö‡∏£‡∏ô‡∏î‡πå
            db.save_product(id, name, price, category, image_url, brand)  # ‡∏™‡πà‡∏á‡πÅ‡∏ö‡∏£‡∏ô‡∏î‡πå‡πÑ‡∏õ‡∏ó‡∏µ‡πà‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô
            st.rerun()
        else:
            st.warning("‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÉ‡∏´‡πâ‡∏Ñ‡∏£‡∏ö‡∏ñ‡πâ‡∏ß‡∏ô")


# Dialog to edit product
@st.dialog("‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤")
def show_dialogEditProd(row_idx, product):
    if product:
        with st.form(key=f"edit_form_{product['id']}"):
            cols = st.columns([1, 3, 2], vertical_alignment="top")
            edit_id = cols[0].text_input("‡∏£‡∏´‡∏±‡∏™‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤", value=product['id'])
            edit_name = cols[1].text_input("‡∏ä‡∏∑‡πà‡∏≠‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤", value=product['name'])
            edit_price = cols[2].number_input("‡∏£‡∏≤‡∏Ñ‡∏≤", min_value=0.0, step=1.0, value=float(product['price']))

            edit_category = st.selectbox("‡∏´‡∏°‡∏ß‡∏î‡∏´‡∏°‡∏π‡πà", ["‡∏≠‡∏≤‡∏´‡∏≤‡∏£‡∏à‡∏≤‡∏ô‡∏´‡∏•‡∏±‡∏Å", "‡∏Ç‡∏≠‡∏á‡∏ó‡∏≤‡∏ô‡πÄ‡∏•‡πà‡∏ô", "‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏î‡∏∑‡πà‡∏°", "‡∏Ç‡∏≠‡∏á‡∏´‡∏ß‡∏≤‡∏ô","‡πÑ‡∏°‡πâ‡∏°‡∏á‡∏Ñ‡∏•"], index=["‡∏≠‡∏≤‡∏´‡∏≤‡∏£‡∏à‡∏≤‡∏ô‡∏´‡∏•‡∏±‡∏Å", "‡∏Ç‡∏≠‡∏á‡∏ó‡∏≤‡∏ô‡πÄ‡∏•‡πà‡∏ô", "‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏î‡∏∑‡πà‡∏°", "‡∏Ç‡∏≠‡∏á‡∏´‡∏ß‡∏≤‡∏ô","‡πÑ‡∏°‡πâ‡∏°‡∏á‡∏Ñ‡∏•"].index(product["category"]))
            
            # ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏ä‡πà‡∏≠‡∏á‡∏Å‡∏£‡∏≠‡∏Å‡πÅ‡∏ö‡∏£‡∏ô‡∏î‡πå
            edit_brand = cols[1].text_input("‡πÅ‡∏ö‡∏£‡∏ô‡∏î‡πå", value=product['brand'])

            edit_status = st.selectbox("‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞", ["active", "inactive"], index=0 if product['status'] == 'active' else 1)
            edit_image_file = st.file_uploader("‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡∏£‡∏π‡∏õ‡∏†‡∏≤‡∏û‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤", type=['png', 'jpg', 'jpeg'])

            if edit_image_file:
                edit_image_url = ut.upload_image_to_cloudinary(edit_image_file)
            else:
                edit_image_url = product['image_url']
           
            if st.form_submit_button("‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å"):
                db.update_product(row_idx, edit_id, edit_name, edit_price, edit_category, edit_status, edit_image_url, edit_brand)  # ‡∏™‡πà‡∏á‡πÅ‡∏ö‡∏£‡∏ô‡∏î‡πå‡πÑ‡∏õ‡∏ó‡∏µ‡πà‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô
                st.success('‡∏≠‡∏±‡∏û‡πÄ‡∏î‡∏ï‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢‡πÅ‡∏•‡πâ‡∏ß')
                st.rerun()


# Product management page
def product_management_page():
    col1, col2 = st.columns([5, 1], vertical_alignment="bottom")
    col1.title("üçú ‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤")
    with col2:
        if st.button('‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤', type="primary"):
            show_dialogAddProd()

    st.subheader("‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î")
    products = db.load_products()

    if products:
        # ‡πÅ‡∏™‡∏î‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏õ‡πá‡∏ô‡∏Å‡∏£‡∏¥‡∏î 4 ‡∏Ñ‡∏≠‡∏•‡∏±‡∏°‡∏ö‡πå
        cols = st.columns(4, vertical_alignment='top', gap='medium')
        for idx, product in enumerate(products):  # Iterate over a copy
            with cols[idx % 4]:
                st.image(product['image_url'], caption=f"{product['id']} - {product['name']}", width=200)
                st.markdown(f"##### ‡∏£‡∏≤‡∏Ñ‡∏≤: ‡∏ø{product['price']:.2f}")
                st.write(f"‡∏´‡∏°‡∏ß‡∏î‡∏´‡∏°‡∏π‡πà: {product['category']}")

                colb1, colb2 = st.columns([3, 2])
                with colb1:
                    if st.button("‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç", key=f"edit_{idx}", type="primary"):
                        show_dialogEditProd(idx, product)
                with colb2:
                    if st.button("‡∏•‡∏ö", key=f"delete_{idx}", type="primary"):
                        products = db.delete_product(idx, products)
                        st.success('‡∏•‡∏ö‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à')
                        st.rerun()
    else:
        st.info("‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤")


# Sidebar menu
def sidebar_menu():
    st.sidebar.image("imi.png", width=180)
    st.sidebar.title("‡πÄ‡∏°‡∏ô‡∏π‡∏´‡∏•‡∏±‡∏Å")
    pages = {
        'orders': 'üìù ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏™‡∏±‡πà‡∏á‡∏ã‡∏∑‡πâ‡∏≠',
        'products': 'üçú ‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤',
        'order_management': 'üìä ‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏≠‡∏≠‡πÄ‡∏î‡∏≠‡∏£‡πå'
    }

    for page_id, page_name in pages.items():
        if st.sidebar.button(page_name):
            st.session_state.current_page = page_id
            st.rerun()


# Order page
def order_page():
    st.title("üìù ‡∏™‡∏±‡πà‡∏á‡∏ã‡∏∑‡πâ‡∏≠‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤")
    products = db.load_products()
    active_products = [p for p in products if p['status'] == 'active']  # ‡∏Å‡∏£‡∏≠‡∏á‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡∏ó‡∏µ‡πà‡∏û‡∏£‡πâ‡∏≠‡∏°‡∏Ç‡∏≤‡∏¢

    if not active_products:
        st.warning("‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡∏ó‡∏µ‡πà‡∏û‡∏£‡πâ‡∏≠‡∏°‡∏Ç‡∏≤‡∏¢ ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡∏Å‡πà‡∏≠‡∏ô")
        return
    col1, col2 = st.columns([4, 2], vertical_alignment="top")
    with col1:
        # Display products in a grid
        st.subheader("‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤")
        cols = st.columns(3, vertical_alignment="top", gap='small')
        if 'order_items' not in st.session_state:
            st.session_state.order_items = {}  # Initialize outside the loop
        for idx, product in enumerate(active_products):
            with cols[idx % 3]:
                st.image(product['image_url'], caption=f"{product['id']} - {product['name']} ‡∏£‡∏≤‡∏Ñ‡∏≤: ‡∏ø{product['price']:.2f}", use_container_width=True)
                quantity = st.number_input(
                    "‡∏™‡∏±‡πà‡∏á‡∏ã‡∏∑‡πâ‡∏≠",
                    min_value=0,
                    value=0,
                    key=f"qty_{idx}"
                )
                if quantity > 0:
                    st.session_state.order_items[product['name']] = {
                        'name': product['name'],
                        'price': product['price'],
                        'quantity': quantity,
                        'subtotal': product['price'] * quantity,
                        'image_url': product['image_url']
                    }
                elif product['name'] in st.session_state.order_items and quantity == 0:
                    # Remove item if quantity is set to 0
                    del st.session_state.order_items[product['name']]
    with col2:
        # Order summary
        st.subheader("‡∏™‡∏£‡∏∏‡∏õ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏™‡∏±‡πà‡∏á‡∏ã‡∏∑‡πâ‡∏≠")
        if hasattr(st.session_state, 'order_items') and st.session_state.order_items:
            order_items_list = list(st.session_state.order_items.values())  # Convert to list
            for item in order_items_list:
                cols = st.columns([1.5, 1, 2])
                with cols[0]:
                    st.image(item['image_url'], caption=f"{item['name']}", use_container_width=True)
                with cols[1]:
                    st.write(f"{item['quantity']} ‡∏ä‡∏¥‡πâ‡∏ô")
                with cols[2]:
                    st.write(f"‡πÄ‡∏õ‡πá‡∏ô‡πÄ‡∏á‡∏¥‡∏ô: ‡∏ø{item['subtotal']:.2f}")

            total = sum(item['subtotal'] for item in st.session_state.order_items.values())
            cols = st.columns(2)
            cols[0].markdown('<h5 style="text-align: right;">‡∏¢‡∏≠‡∏î‡∏£‡∏ß‡∏°</h5>', unsafe_allow_html=True)
            cols[1].markdown(f'<h5 style="text-align: right;">‡∏ø{total:.2f}</h5>', unsafe_allow_html=True)

            customer_name = st.text_input("‡∏ä‡∏∑‡πà‡∏≠‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤")
            special_instructions = st.text_area("‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÄ‡∏ï‡∏¥‡∏°")

            if st.button("‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏Å‡∏≤‡∏£‡∏™‡∏±‡πà‡∏á‡∏ã‡∏∑‡πâ‡∏≠"):
                if customer_name:
                    db.save_order(customer_name, order_items_list, total, special_instructions)  # Pass the list
                    st.session_state.order_items = {}  # Reset order items after order
                    st.rerun()
                else:
                    st.warning("‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡∏ä‡∏∑‡πà‡∏≠‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤")


# Order management page
def order_management_page():
    def order_management_page():
         st.header("‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏≠‡∏≠‡πÄ‡∏î‡∏≠‡∏£‡πå")
    orders = db.load_orders()  # Load all orders from Google Sheets

    if not orders:
        st.info("‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏≠‡∏≠‡πÄ‡∏î‡∏≠‡∏£‡πå")
        return

    for idx, order in enumerate(orders):
        # ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏ß‡πà‡∏≤‡∏Ñ‡∏µ‡∏¢‡πå customer_name ‡πÅ‡∏•‡∏∞ total ‡∏°‡∏µ‡∏≠‡∏¢‡∏π‡πà‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà
        customer_name = order.get("customer_name", "‡πÑ‡∏°‡πà‡∏£‡∏∞‡∏ö‡∏∏")
        total = order.get("total", 0)
        order_date = order.get("timestamp", "‡πÑ‡∏°‡πà‡∏£‡∏∞‡∏ö‡∏∏")

        with st.expander(f"‡∏≠‡∏≠‡πÄ‡∏î‡∏≠‡∏£‡πå {idx+1} - ‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤: {customer_name} : ‡∏¢‡∏≠‡∏î‡∏£‡∏ß‡∏°: ‡∏ø{total:.2f} ({order_date})"):
            st.json(order)  # ‡πÅ‡∏™‡∏î‡∏á‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î‡∏Ç‡∏≠‡∏á‡∏≠‡∏≠‡πÄ‡∏î‡∏≠‡∏£‡πå‡πÉ‡∏ô‡∏£‡∏π‡∏õ‡πÅ‡∏ö‡∏ö JSON
            new_status = st.selectbox(
                f"‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏≠‡∏≠‡πÄ‡∏î‡∏≠‡∏£‡πå (‡∏≠‡∏≠‡πÄ‡∏î‡∏≠‡∏£‡πå {idx+1})",
                ["pending", "completed", "cancelled"],
                index=["pending", "completed", "cancelled"].index(order.get("status", "pending"))
            )
            if st.button(f"‡∏≠‡∏±‡∏û‡πÄ‡∏î‡∏ó‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏≠‡∏≠‡πÄ‡∏î‡∏≠‡∏£‡πå {idx+1}"):
                db.update_order(idx, new_status)


# Main App
def main():
    sidebar_menu()
    if not st.session_state.client:
        st.error("‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤ Google Sheets API ‡∏Å‡πà‡∏≠‡∏ô‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô")
        return

    if st.session_state.current_page == 'products':
        product_management_page()
    elif st.session_state.current_page == 'orders':
        order_page()
    elif st.session_state.current_page == 'order_management':
        order_management_page()


# ========================================================================
if __name__ == "__main__":
    main()
